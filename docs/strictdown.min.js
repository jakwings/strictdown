/*
 **************************************************************************** \
 Date: 2017-06-08 18:35:31 +08:00
 Author: Jak Wings
 License: MIT Licensed
 Website: https://github.com/jakwings/strictdown
 Description: strictdown, a parser for a Markdown variant -- Strictdown
 Thanks to:
   https://github.com/chjj/marked
   https://github.com/evilstreak/markdown-js
   http://kramdown.gettalong.org/syntax.html
   https://sourceforge.net/p/forge/documentation/markdown_syntax/
\******************************************************************************/
(function(S){var m=function(b,f){return b.replace(f?/&(?!#?\w+;)/g:/&/g,"&amp;").replace(/[<>"']/g,function(b){switch(b){case "<":return"&lt;";case ">":return"&gt;";case '"':return"&quot;";case "'":return"&#39;";default:return b}})},O=function(b){return b.replace(/[-\\.+*?^|$\[\](){}]/g,function(b){return"\\x"+b.charCodeAt(0).toString(16)})},C=/^  *|(\\ )|  *$/gm,L=/\\([-*+_.`~^":\[\]<>(){}|@&=#\\])/g,D=/\\([-*+_.`~^":\[\]<>(){}|@&=#\\ ])/g,H=function(b){for(var f,d=1,a=arguments.length;d<a;d++){f=
arguments[d];for(var h in f)Object.prototype.hasOwnProperty.call(f,h)&&(b[h]=f[h])}return b},P=function(b){"number"!==typeof b&&(b=b.length);var f="",d=" ";for(b|=0;0<b;b>>>=1,d+=d)b&1&&(f+=d);return f},R=function(b){var f=[],d="",a,h,r=0;for(a=0;h=b.charAt(a);a++)if("|"!==h&&"^"!==h||"\\"===c){var c=h;d+=h;r++}else d&&(f.push(d),d=""),c=h,f.push(h);d&&f.push(d);f.cellLength=r;return f},I=function(b,f){return(f.match(b)||[]).length===f.split("\n").length},Q=function(b){b=b.replace(/^ *\n(?: *\n)*/,
"");for(var f=/([\s\S][\s\S]*?)(\n *\n(?: *\n)*|\n *$|$)/g,d=[],a;a=f.exec(b);)d.push(a[1]),a[2]&&d.push(a[2]);return d},n={blanklines:/^\n/,eob:/^\^ *$/,macro:/^<\[((?:\\[\s\S]|[^\\])+)*\]> *$/,macro_start:/^<\[([\s\S]*)/,macro_end:/(?:^|\n)\]> *$/,code:/^    [^\n][^\n]*(?:\n    [^\n][^\n]*)*$/,fences:/^(~~~~*)[^\n]*(\n[\s\S]+?)?\n\1~* *$/,fences_start:/^(~~~~*)([^\n]*)/,fences_end:/(?:^|\n)(~~~~*) *$/,setext:/^([\s\S]+?)\n(?:(=)=*|--*) *$/,atx:/^(##{0,5})(?!#)((?:\\[\s\S]|[^\\])+?)(?:##* *)?$/,
blockquote:/^>( *)[^\n]*(?:\n>(?:\1[^\n]*|))*$/,ul:/^[+\-*] /,ol:/^\d\d*\. /,dl:/^([^: ][^\n]*(?:\n[^: ][^\n]*)*)\n(: [\s\S]*)$/,dd:/^:(  *)[^\n]*(?:\n \1[^\n]*)*$/,dd_pedantic:/^:  *[^\n]*(?:\n    [^\n]*)*$/,link:/^:\[(?![\^*@])([^\[\]\n\\][^\[\]\n\\]*)\]:  *([^ \n][^ \n]*) *(?:\n?  *"((?:\\["\\]|[^"\\\n])*)" *)?$/,links:/^:\[(?![\^*@])[^\[\]\n\\][^\[\]\n\\]*\]: /,abbr:/^\*\[([^\[\]\n\\][^\[\]\n\\]*)\]: ([^\n][^\n]*(?:\n [^\n][^\n]*)*)$/,abbrs:/^\*\[[^\[\]\n\\][^\[\]\n\\]*\]: /,footnotex:/^\^\[([^\[\]\n\\][^\[\]\n\\]*)\]: *((?:\n    [^\n][^\n]*)+)$/,
footnote:/^\^\[([^\[\]\n\\][^\[\]\n\\]*)\]: ([^\n][^\n]*(?:\n [^\n][^\n]*)*)$/,footnotes:/^\^\[[^\[\]\n\\][^\[\]\n\\]*\]: /,image:/^@\[([^\[\]\n\\][^\[\]\n\\]*)\]:  *([^ \n][^ \n]*) *(?:\n?  *([^ "',:;\n\}][^ "',:;\n\}]*,[^ "',:;\n\}][^ "',:;\n\}]*)?(:left|:right)? *)?(?:\n?  *"((?:\\["\\]|[^"\\\n])*)" *)?$/,images:/^@\[[^\[\]\n\\][^\[\]\n\\]*\]: /,figure:/^\[((?:\\[\s\S]|[^\\\]])+?)\]@<([^ \n][^ \n]*)(?: *\n?  *([^ "',:;\n\}][^ "',:;\n\}]*,[^ "',:;\n\}][^ "',:;\n\}]*)?(:left|:right)?)?(?: *\n?  *"((?:\\["\\]|[^"\\\n])*)")?> *$/,
figures:/^\[(?:\\[\s\S]|[^\\\]])+?\]@<[^ \n]/,hr:/^(?:- *- *- *(?:- *)*|\* *\* *\* *(?:\* *)*)$/,table:/^\+(?:==*|--*)\+ *(?:\n[\^|][^\n][^\n]*[\^|] *)*\n\+--*\+ *$/,table_line:/^([\^|+])(?:(=)=*|--*)([\^|+]) *$/,paragraph:/^[^\n][^\n]*(?:\n[^\n][^\n]*)*$/,subindented:/^(  *)[^\n][^\n]*(?:\n\1[^\n][^\n]*)*$/};n.normal={code:[0,n.code],eob:[1,n.eob],fences:[2,n.fences_start],setext:[3,n.setext],atx:[4,n.atx],blockquote:[5,n.blockquote],hr:[6,n.hr],ul:[7,n.ul],ol:[8,n.ol],links:[9,n.links],images:[10,
n.images],figures:[11,n.figures],footnotex:[12,n.footnotex],footnotes:[13,n.footnotes],abbrs:[14,n.abbrs],table:[15,n.table],dl:[16,n.dl],macro:[17,n.macro_start],paragraph:[18,n.paragrap]};var E=function(b){this.options=H({},u.defaults,b||{});this.rules=n.normal;this.tokens=[];this.tokens.links={};this.tokens.images={};this.tokens.abbrs={};this.tokens.notes={};this.tokens.headings=[];b=[];for(var f in this.rules)b.push([this.rules[f][0],f]);b.sort(function(a,b){return a[0]<b[0]?-1:1});f=0;for(var d=
b.length;f<d;f++)b[f]=b[f][1];this.ruleNames=b;this.index=0;this.headingIndex=this.noteIndex=1};E.lex=function(b,f){return(new E(f)).lex(b)};E.prototype.lex=function(b){b=b.replace(/\r\n?/g,"\n");this.options.pedantic&&this.options.hardtab&&(b=b.replace(/\t/g,"    "));var f=this.options.pedantic?0:"";return this.tokenize(Q(b),f,!0,!0,!1,!1)};E.prototype.tokenize=function(b,f,d,a,h,r){var c,g=!this.options.pedantic,p=g?f.length:4*f,e=new RegExp("^"+P(p)+"","gm"),m=p?new RegExp("^ {1,"+p+"}","gm"):
/^$/,D=this.index;var q=a?this.index:this.index=0;var G=b.length;a:for(;q<G;q++){var k=b[q];if(n.blanklines.test(k))r=!1;else{if(I(e,k)){if(k=k.replace(m,""),g&&!r&&/^  {0,2}(?! )/.test(k)){var F=n.subindented.exec(k);if(F&&4>F[1].length){this.index=q;this.tokenize(b,f+F[1],d,!0,h,!0);q=this.index-1;continue}r=!1}}else break a;for(F=0;c=this.ruleNames[F];F++){var t=this.rules[c][1];var l=null;b:switch(c){case "eob":if(t.test(k))continue a;break;case "macro":if(l=t.exec(k)){c=l[1]||"";if(l=n.macro.exec(k))c=
l[1]||"",F=(c.match(/^[^ \n][^ \n]*/)||[""])[0],c=c.substr(F.length).replace(/^\n\n*/,"");else for(F=(c.match(/^[^ \n][^ \n]*/)||[""])[0],c=c.substr(F.length).replace(/^\n\n*/,"");++q<G;){for(k=b[q]||"";q<G&&n.blanklines.test(k);)c+=k.replace(m,""),k=b[++q]||"";if(!I(e,k)){c=c.replace(/\n\n*$/,"");q--;break}k=k.replace(m,"");if(n.macro_end.test(k)){c+=k.replace(n.macro_end,"");break}c+=k}if(k=this.options.macros[F])k=k.call(u,this,{type:"macro",name:F,text:c}),this.tokens.push(k);continue a}break;
case "code":if(t.test(k)){for(c=k.replace(/^    /gm,"");++q<G;){for(k=b[q]||"";q<G&&n.blanklines.test(k);)c+=k.replace(m,"").replace(/^  {0,3}/gm,""),k=b[++q]||"";k=k.replace(m,"");if(t.test(k))c+=k.replace(/^    /gm,"");else{c=c.replace(/\n\n*$/,"");q--;break}}this.tokens.push({type:"code",text:c,lang:""});continue a}break;case "fences":if(l=t.exec(k)){F=l[1];var w=(l[2]||"").replace(/^  *|  *$/g,"");var v=w.match(/^(\**)/)[1].length;c=k.replace(n.fences_start,"").replace(/^\n/,"");if(l=n.fences.exec(k))c=
(l[2]||"").substr(1);else for(;++q<G;){for(k=b[q]||"";q<G&&n.blanklines.test(k);)c+=k.replace(m,""),k=b[++q]||"";if(!I(e,k)){c=c.replace(/\n\n*$/,"");q--;break}k=k.replace(m,"");if((l=n.fences_end.exec(k))&&l[1].length>=F.length){c+=k.replace(n.fences_end,"");break}c+=k}this.tokens.push({type:"code",lang:w.substr(v),text:c,raw:0<v,mix:1<v});continue a}break;case "setext":if(l=t.exec(k)){c=l[1].replace(C,"$1");this.tokens.push({type:"heading",text:c,size:l[2]?1:2});d&&this.tokens.headings.push({size:l[2]?
1:2,text:c,index:this.headingIndex++});continue a}break;case "atx":if((l=t.exec(k))&&(c=l[2].replace(C,"$1"))&&"\n"!==c){this.tokens.push({type:"heading",text:c,size:l[1].length});d&&this.tokens.headings.push({size:l[1].length,text:c,index:this.headingIndex++});continue a}break;case "blockquote":if(l=t.exec(k)){this.tokens.push({type:"quote_start"});do{c=k.replace(new RegExp("^>(?:"+l[1]+")?","gm"),"");this.tokenize(Q(c),g?"":0,!1,!1,h);for(k=b[++q]||"";q<G&&n.blanklines.test(k);)k=b[++q]||"";if(!I(e,
k)||!(l=t.exec(k=k.replace(m,"")))){q--;break}}while(q<G);this.tokens.push({type:"quote_end"});continue a}break;case "ul":var A=!0;case "ol":A=A||!1;if(t.test(k)){var z=!0;var x=0;v=this.tokens.push({type:A?"ul_start":"ol_start"})-1;c:for(;;){var y=A?k.split(/\n(?=[+\-*] )/):k.split(/\n(?=\d\d*\. )/);c=0;for(w=y.length-1;c<w;c++){var B=P(g?y[c].match(/^[^ ]+  */)[0]:p+4);l=new RegExp("^[^\\n]+(?:\\n"+B+"[^\\n][^\\n]*)*$");if(!l.test(y[c])){0===x?(z=!1,this.tokens.splice(v)):q--;break c}this.tokens.push({type:"li",
text:y[c].replace(/^[^ ]+ +\n?/,"").replace(C,"$1")})}c=y.pop();B=P(g?c.match(/^[^ ]+/)[0]:p+4);l=new RegExp(g?"^[^ ]+( +)[^\\n]*(?:\\n"+B+"\\1[^\\n][^\\n]*)*$":"^[^\\n]+(?:\\n"+B+"[^\\n][^\\n]*)*$");if(!(l=l.exec(c))){0===x?(z=!1,this.tokens.splice(v)):q--;break c}w=this.tokens.push({type:"li_start"});this.tokens.push({type:"text",text:c.replace(/^[^ ]+ +\n?/,"").replace(C,"$1")});this.index=q+1;g?this.tokenize(b,f+B+l[1],d,!0,h):this.tokenize(b,f+1,d,!0,h);this.tokens[v].complex||(1<this.tokens.length-
w?this.tokens[v].complex=!0:1===this.tokens.length-w&&"text"!==this.tokens[w].type&&(this.tokens[v].complex=!0));this.tokens.push({type:"li_end"});q=this.index;for(k=b[q]||"";q<G&&n.blanklines.test(k);)k=b[++q]||"";if(!I(e,k)||!t.test(k=k.replace(m,""))){q--;break}x++}if(z){A?this.tokens.push({type:"ul_end"}):this.tokens.push({type:"ol_end"});A=null;continue a}}A=null;break;case "dl":if(l=t.exec(k)){z=!0;x=0;v=this.tokens.push({type:"dl_start"})-1;c:do{B=l[1].replace(C,"$1").split("\n");c=0;for(w=
B.length;c<w;c++)this.tokens.push({type:"dt",text:B[c]});for(;;){B=(l&&l[2]||k).split(/\n(?=: )/);l=g?n.dd:n.dd_pedantic;c=0;for(w=B.length-1;c<w;c++){if(!l.test(B[c])){0===x?(z=!1,this.tokens.splice(v)):q--;break c}this.tokens.push({type:"dd",text:B[c].replace(/^: +\n?/,"").replace(C,"$1")})}w=this.tokens.push({type:"dd_start"});c=B.pop();if(!(l=l.exec(c))){0===x?(z=!1,this.tokens.splice(v)):q--;break c}this.tokens.push({type:"text",text:c.replace(/^: +\n?/,"").replace(C,"$1")});this.index=q+1;g?
this.tokenize(b,f+" "+l[1],d,!0,h):this.tokenize(b,f+1,d,!0,h);this.tokens[v].complex||(1<this.tokens.length-w?this.tokens[v].complex=!0:1===this.tokens.length-w&&"text"!==this.tokens[w].type&&(this.tokens[v].complex=!0));this.tokens.push({type:"dd_end"});q=this.index;for(k=b[q]||"";q<G&&n.blanklines.test(k);)k=b[++q]||"";if(!I(e,k)||!n.dd.test(k=k.replace(m,"")))break;l=null}for(k=b[q]||"";q<G&&n.blanklines.test(k);)k=b[++q]||"";if(!I(e,k)||!(l=t.exec(k=k.replace(m,"")))){q--;break}x++}while(1);
if(z){this.tokens.push({type:"dl_end"});continue a}}break;case "links":if(t.test(k)){x=k.split(/\n(?=:)/);t={};c=0;for(w=x.length;c<w;c++)if(l=n.link.exec(x[c]))v=l[1].toLowerCase(),t[v]={href:l[2],title:(l[3]||"").replace(/\\(["\\])/g,"$1")};else break b;H(this.tokens.links,t);continue a}break;case "images":if(t.test(k)){z=k.split(/\n(?=@)/);t={};c=0;for(w=z.length;c<w;c++)if(l=n.image.exec(z[c]))v=l[1].toLowerCase(),x=(l[3]||"").split(","),t[v]={href:l[2],title:(l[5]||"").replace(/\\(["\\])/g,"$1"),
width:x[0]||"",height:x[1]||"",align:(l[4]||"").substr(1)};else break b;H(this.tokens.images,t);continue a}break;case "figures":if(t.test(k)){t=k.split(/\n(?=\[)/);v=this.tokens.length;c=0;for(w=t.length;c<w;c++)if(l=n.figure.exec(t[c]))x=(l[3]||"").split(","),this.tokens.push({type:"figure",text:l[1].replace(C,"$1"),href:l[2],title:(l[5]||"").replace(/\\(["\\])/g,"$1"),width:x[0]||"",height:x[1]||"",align:(l[4]||"").substr(1)});else{this.tokens.splice(v);break b}continue a}break;case "footnotex":if(!h&&
(l=t.exec(k))){v=l[1].toLowerCase();this.tokens.notes[v]={index:this.noteIndex,text:"",escaped:!0,refs:[]};this.tokens.push({type:"note_start",name:v,index:this.noteIndex++});b[q]=l[2].substr(1);this.index=q;g?this.tokenize(b,f+"    ",d,!0,!0):this.tokenize(b,f+1,d,!0,!0);q=this.index-1;this.tokens.push({type:"note_end"});continue a}break;case "footnotes":if(!h&&t.test(k)){x=k.split(/\n(?=\^)/);t={};c=0;for(w=x.length;c<w;c++)if(l=n.footnote.exec(x[c]))v=l[1].toLowerCase(),t[v]={index:this.noteIndex++,
text:l[2].replace(C,"$1"),escaped:!1,refs:[]};else break b;H(this.tokens.notes,t);continue a}break;case "abbrs":if(t.test(k)){x=k.split(/\n(?=\*)/);t={};c=0;for(w=x.length;c<w;c++)if(l=n.abbr.exec(x[c]))v=l[1],t[v]=l[2].replace(C,"$1");else break b;H(this.tokens.abbrs,t);continue a}break;case "hr":if(t.test(k)){this.tokens.push({type:"hr"});continue a}break;case "table":if(t.test(k)){v=this.tokens.push({type:"table_start"})-1;t=k.split("\n");B=z=x=!1;y=null;c=0;for(w=t.length-1;c<=w;c++)if(l=n.table_line.exec(t[c])){if(0!==
c&&c!==w&&("|"!==l[1]||"|"!==l[3])){this.tokens.splice(v);break b}if(0===c)l[2]?(x=!0,this.tokens.push({type:"thead_start"})):(z=!0,this.tokens.push({type:"tbody_start"}));else if(x)if(l[2])x=!1,this.tokens.push({type:"thead_end"}),z=!0,this.tokens.push({type:"tbody_start"});else{this.tokens.splice(v);break b}else if(!B&&l[2])z&&(z=!1,this.tokens.push({type:"tbody_end"})),B=!0,this.tokens.push({type:"tfoot_start"});else if(B)if(c<w||l[2]){this.tokens.splice(v);break b}else this.tokens.push({type:"tfoot_end"});
else z?(z=!1,this.tokens.push({type:"tbody_end"})):(z=!0,this.tokens.push({type:"tbody_start"}))}else{z||x||B||(z=!0,this.tokens.push({type:"tbody_start"}));l=t[c].replace(/[^ ] *$/g,"");if("\\"===l.charAt(l.length-1)){this.tokens.splice(v);break b}l=R(l);this.tokens.push({type:"tr_start"});y=y||Array(l.cellLength);for(var E=Array(l.cellLength),M=null,L,N=0,J=0,O=l.length-1;J<=O;J++){if(/^[\^|]?$/.test(l[J+1]||""))M&&this.tokens[M].colspan++;else if(J<O){var K=l[J+1];/^ *::: *$/.test(K)?(L=this.tokens[y[N]])?
(L.rowspan++,E[N]=y[N]):(M=this.tokens.push({type:"|"===l[J]?"td":"th",text:K.replace(C,"$1"),align:/^  /.test(K)?/  $/.test(K)?"center":"right":"left",colspan:1,rowspan:1})-1,E[N]=M):(M=this.tokens.push({type:"|"===l[J]?"td":"th",text:K.replace(C,"$1").replace(/\\([\^|])/g,"$1"),align:/^  /.test(K)?/  $/.test(K)?"center":"right":"left",colspan:1,rowspan:1})-1,E[N]=M);J++}N++}this.tokens.push({type:"tr_end"});y=E}this.tokens.push({type:"table_end"});continue a}break;case "paragraph":this.tokens.push({type:"p",
text:k.replace(C,"$1")});continue a;default:throw Error('Rule "'+c+'" does not have a handler.');}}throw Error("Infinite loop on block"+q+": <["+k+"]>");}}this.index=a?q:D;return this.tokens};var U={escape:[0,/^\\([\s\S]?)/],verbatim:[1,/^(``*)((?:\\`|[\s\S])+?)(\1`*)(?:\((?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)\))?/],strong:[2,/^(\*\**)(?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)(\*\**)/],em:[3,/^(__*)(?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)(__*)/],del:[4,/^(~~*)(?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)(~~*)/],
ref:[5,/^\|(?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)\|/],anchor:[6,/^\{(?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)\}/],autolink:[7,/^\[\[(?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)\]\]/],image:[8,/^\[(?![ \n])((?:\\[\s\S]|[^\\])*?)([ \n]*)\]@(?:\[(?![ \n])((?:\\[\s\S]|[^\\])*?)([ \n]*)\]|\((?![ \n])((?:\\[\s\S]|[^\\])*?)([ \n]*)\))/],link:[9,/^\[(?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)\](?::\[(?![ \n])((?:\\[\s\S]|[^\\])*?)([ \n]*)\]|:\((?![ \n])((?:\\[\s\S]|[^\\])*?)([ \n]*)\))?/],footnote:[10,/^\^\[(?![ \n])((?:\\[\s\S]|[^\\])+?)([ \n]*)\]/],
comment:[11,/^\x3c!--[\s\S]*?--\x3e/],tag:[12,/^<\/?\w+(?:"[^"]*"|'[^']'| *[^"'>])*>/]};var A=function(b,f){this.options=H({},u.defaults,f||{});this.options.generalPrefix=m(this.options.generalPrefix);this.options.languagePrefix=m(this.options.languagePrefix);this.rules=U;this.options.sanitize&&(delete this.rules.tag,delete this.rules.comment);this.links=b.links||{};this.images=b.images||{};this.abbrs=b.abbrs||{};this.notes=b.notes||{};this.headings=b.headings||[];var d=[];for(a in this.rules)d.push([this.rules[a][0],
a]);d.sort(function(a,b){return a[0]<b[0]?-1:1});var a=0;for(var h=d.length;a<h;a++)d[a]=d[a][1];this.ruleNames=d;this.refIndex=0};A.translate=function(b,f,d,a){return(new A(f,d)).translate(b,!a)};A.prototype.translate=function(b,f,d){var a,h,r=this.options,c="",g="";a:for(;b;){for(a=0;h=this.ruleNames[a];a++){var p=this.rules[h][1];var e=null;switch(h){case "escape":if(e=p.exec(b)){b=b.substr(2);if(d){e[1]||(e[0]+="\n");g+=e[0].replace(D,"$1");continue a}g=" "===e[1]?g+"&nbsp;":"\n"!==e[1]&&e[1]?
g+m(e[0].replace(L,"$1")):g+"\\\n";continue a}break;case "strong":case "em":case "del":if(e=p.exec(b))if(e[3]||2!==e[1].length||e[1].length!==e[4].length)b=b.substr(e[1].length),g+=e[1];else{b=b.substr(e[0].length);if(d){g=this.wrap(g,null,!0);g+=this.translate(e[2],null,!0);c+=g;g="";continue a}g=this.wrap(this.abbr(m(g,!0)),f);g="strong"===h?g+("<strong>"+this.translate(e[2])+"</strong>"):"em"===h?g+("<em>"+this.translate(e[2])+"</em>"):g+("<del>"+this.translate(e[2])+"</del>");c+=g;g="";continue a}break;
case "verbatim":if(e=p.exec(b))if(p=!0,e[4]=e[4]||"",e[5]=e[5]||"",!e[2]||"`"===e[2]||1<e[1].length&&(2>e[3].length||e[5])?p=!1:1===e[1].length&&(1===e[3].length&&/^(?:\\[`\\]|[^`\\])+$/.test(e[2])||(p=!1)),p){b=1!==e[1].length?b.substr(e[0].length):b.substr(e[1].length+e[2].length+e[3].length);if(d){g=this.wrap(g,null,!0);g=1===e[1].length?g+this.wrap(e[2].replace(/\\([\\`])/g,"$1"),null,!0):g+this.wrap(e[2],null,!0);c+=g;g="";continue a}g=this.wrap(this.abbr(m(g,!0)),f);1===e[1].length?(p=e[2].replace(/\\([\\`])/g,
"$1"),g+='<span class="'+r.generalPrefix+'literal">'+this.wrap(this.abbr(m(p)))+"</span>"):(a="",e[4]&&(a=e[4].replace(D,"$1"),r.sanitize&&(a=a.replace(/  */g,"-")),a=' class="'+r.languagePrefix+m(a)+'"'),p=e[2]+e[3].slice(0,0-e[1].length),g+="<code"+a+">"+this.wrap(this.abbr(m(p)))+"</code>");c+=g;g="";continue a}else b=b.substr(e[1].length),g+=e[1];break;case "link":if((e=p.exec(b))&&!(e[2]||e[4]||e[6])){b=b.substr(e[0].length);if(d){g=this.wrap(g,null,!0);g+=this.translate(e[1],null,!0);c+=g;g=
"";continue a}g=this.wrap(this.abbr(m(g,!0)),f);p=e[1];a=(e[3]||"").replace(D,"$1");h=(e[5]||"").replace(D,"$1");e="";if(h)h=m(this.shapeUri(this.wrap(h,null,!0)));else switch(a=this.wrap(a,null,!0),a.charAt(0)){case "^":a=a.substr(1).toLowerCase();this.notes[a]&&(h="#"+r.generalPrefix+"footnote-"+this.notes[a].index);break;case "@":a=a.substr(1).toLowerCase();this.images[a]&&(h=m(this.shapeUri(this.images[a].href)),e=m(this.images[a].title));break;case "*":a=a.substr(1).toLowerCase();h="#"+r.generalPrefix+
"anchor-"+m(a);e=m(a);break;default:a=(a||this.translate(p,null,!0)).toLowerCase(),this.links[a]&&(h=m(this.shapeUri(this.links[a].href)),e=m(this.links[a].title))}g+='<a class="'+r.generalPrefix+'ref-link"'+(h?' href="'+h+'"':"")+(e?' title="'+e+'"':"")+">"+this.translate(p)+"</a>";c+=g;g="";continue a}break;case "autolink":if((e=p.exec(b))&&!e[2]){if(d){g=this.wrap(g,null,!0);p=this.wrap(e[1].replace(D,"$1"),null,!0);g=/^[@:^]/.test(p)?g+p.substr(1):g+p;c+=g;g="";continue a}b=b.substr(e[0].length);
g=this.wrap(this.abbr(m(g,!0)),f);a=this.wrap(e[1].replace(D,"$1"),null,!0);p=e=h="";switch(a.charAt(0)){case "@":p="raw";a=a.substr(1).toLowerCase();this.images[a]&&(h=m(this.shapeUri(this.images[a].href,!0)),e=m(this.images[a].title),a=h);break;case ":":p="raw";a=a.substr(1).toLowerCase();this.links[a]&&(h=m(this.shapeUri(this.links[a].href,!0)),e=m(this.links[a].title),a=h);break;case "^":p="ref";a=a.substr(1);this.notes[a.toLowerCase()]&&(h="#"+r.generalPrefix+"footnote-"+this.notes[a.toLowerCase()].index,
a=m(a));break;default:!/^[^ \n][^ \n]*@[^ \/\n][^ \/\n]*$/.test(a)||/^[A-Za-z][+\-.0-9A-Za-z]*:/.test(a)?(p="raw",a=h=m(this.shapeUri(a,!0))):(p="mail",a=a.replace(/./g,function(a){return"&#"+a.charCodeAt(0)+";"}),h="mailto:"+a)}g+='<a class="'+r.generalPrefix+p+'-link"'+(h?' href="'+h+'"':"")+(e?' title="'+e+'"':"")+">"+a+"</a>";c+=g;g="";continue a}break;case "footnote":if((e=p.exec(b))&&!e[2]){b=b.substr(e[0].length);if(d){g=this.wrap(g,null,!0);c+=g;g="";continue a}g=this.wrap(this.abbr(m(g,!0)),
f);a=this.wrap(e[1].replace(D,"$1"),null,!0);p=0;this.notes[a]&&(p=this.notes[a].index,this.notes[a].refs.push(++this.refIndex));g+="<a"+(p?' id="'+r.generalPrefix+"ref-footnote-"+this.refIndex+'"':"")+' class="'+r.generalPrefix+'ref-footnote"'+(p?' href="#'+r.generalPrefix+"footnote-"+p+'"':"")+"><sup>"+p+"</sup></a>";c+=g;g="";continue a}break;case "image":if((e=p.exec(b))&&!(e[2]||e[4]||e[6])){b=b.substr(e[0].length);if(d){g=this.wrap(g,null,!0);g+=this.wrap(e[1].replace(D,"$1"),null,!0);c+=g;
g="";continue a}g=this.wrap(this.abbr(m(g,!0)),f);p=this.wrap(e[1].replace(D,"$1"),null,!0);a=(e[3]||"").replace(D,"$1");h=(e[5]||"").replace(D,"$1");var n=e="",u="",q="";h?h=m(this.shapeUri(this.wrap(h,null,!0))):(a=this.wrap(a,null,!0).toLowerCase(),this.images[a]&&(h=this.shapeUri(this.images[a].href),e=this.images[a].title,n=this.filterCss(this.images[a].width),u=this.filterCss(this.images[a].height),q=this.images[a].align));a="";r.stylish&&(n||u)&&(a=' style="'+(q?"float:"+m(q)+";":"")+(n?"width:"+
m(n)+";":"")+(u?"height:"+m(u)+";":"")+'"');g+='<img src="'+m(h)+'"'+(p?' alt="'+m(p)+'"':"")+(e?' title="'+m(e)+'"':"")+(!r.stylish&&q?' align="'+q+'"':"")+(r.stylish?a:(n?' width="'+m(n)+'"':"")+(u?' height="'+m(u)+'"':""))+(r.xhtml?"/>":">");c+=g;g="";continue a}break;case "anchor":case "ref":if((e=p.exec(b))&&!e[2]){b=b.substr(e[0].length);if(d){g=this.wrap(g,null,!0);g+=this.translate(e[1],null,!0);c+=g;g="";continue a}g=this.wrap(this.abbr(m(g,!0)),f);p=e[1];a=this.translate(p,null,!0).replace(/  */g,
"-").toLowerCase();g="anchor"===h?g+('<a class="'+r.generalPrefix+'anchor" id="'+r.generalPrefix+"anchor-"+m(a)+'"></a>'+this.translate(p)):g+('<a class="'+r.generalPrefix+'ref-anchor" href="#'+r.generalPrefix+"anchor-"+m(a)+'">'+this.translate(p)+"</a>");c+=g;g="";continue a}break;case "comment":case "tag":if(e=p.exec(b)){b=b.substr(e[0].length);if(d)continue a;g=this.wrap(this.abbr(m(g,!0)),f);c+=g+e[0];g="";continue a}break;default:throw Error('Format "'+h+'" does not have a handler.');}}g+=b.charAt(0);
b=b.substr(1)}g&&(c=d?c+this.wrap(g,null,!0):c+this.wrap(this.abbr(m(g,!0)),f));return c};A.prototype.wrap=function(b,f,d){if(this.nowrap)return b;var a=this.options;switch(a.wrappingMode){case "default":b=d?b.replace(/\\\n/g,"\r").replace(/\n/g," ").replace(/\r/g,"\n"):b.replace(/\\\n/g,a.xhtml?"<br/>":"<br>").replace(/\n/g," ");break;case "break":d||(b=b.split("\n").join(a.xhtml?"<br/>\n":"<br>\n"));break;case "paragraph":d||(b=f?b.split("\n").join("</p>\n<p>"):b.split("\n").join(a.xhtml?"<br/>\n":
"<br>\n"));break;case "ignore":b=d?b.replace(/\\(\n)|\n/g,"$1"):b.replace(/\\\n/g,a.xhtml?"<br/>":"<br>").replace(/\n/g,"");break;default:throw Error('Invalid wrapping mode: "'+a.wrappingMode+'"');}return b};A.prototype.abbr=function(b){var f=[],d={},a;for(a in this.abbrs){var h=m(a,!0);d[h]=this.abbrs[a];f.push(O(h))}if(!f.length)return b;var f=new RegExp(f.join("|"),"g"),r=this;return b.replace(f,function(a){return'<abbr title="'+r.wrap(m(d[a]),null,!0)+'">'+a+"</abbr>"})};A.prototype.shapeUri=
function(b,f){var d=this.options.baseUri;if(!f||!d)return this.filterUri(b);/^[A-Za-z][+\-.0-9A-Za-z]*:/.test(b)||(b="//"===b.substr(0,2)?(d.match(/^[^:]+:/)||[""])[0]+b:"?"===b.charAt(0)||"#"===b.charAt(0)?d+b:"/"===b.charAt(0)?(d.match(/^[^:]+:\/\/[^\/]+/)||[""])[0]+b:d.replace(/^([^:]+:\/\/[\s\S]+)\/[^\/]*$/,"$1")+"/"+b);return this.filterUri(b)};A.prototype.filterUri=function(b){return this.options.sanitize?b.replace(/( )|\s/g,"$1").replace(/^\s*javascript\s*:/i,"XSS"):b};A.prototype.filterCss=
function(b){return this.options.sanitize?b.replace(/\s/g,"").replace(/expression/i,"XSS"):b};var y=function(b){this.options=H({},u.defaults,b||{});this.options.generalPrefix=m(this.options.generalPrefix);this.options.languagePrefix=m(this.options.languagePrefix);this.token=null;this.headingIndex=1};y.parse=function(b,f){return(new y(f)).parse(b)};y.prototype.parse=function(b){this.inlineLexer=new A({links:b.links,images:b.images,abbrs:b.abbrs,notes:b.notes,headings:b.headings},this.options);b.reverse();
this.tokens=b;for(b="";this.next();)b+=this.translate(!0);b+=this.generateFootnote(this.tokens.notes);return"\n"===b.charAt(0)?b.substr(1):b};y.prototype.next=function(){return this.token=this.tokens.pop()};y.prototype.translate=function(b){var f=this.options,d=this.token,a=d.text||"";switch(d.type){case "p":a="\n<p>"+this.inlineLexer.translate(a,!0)+"</p>";break;case "code":b=d.escaped;var h=d.lang;f.sanitize&&d.raw&&!f.highlight&&(d.raw=d.mix=!1);if(f.highlight&&!d.mix&&!b){var r=f.highlight(a,
h,d.raw);r&&(b=!0,a=r)}d.raw?d.mix&&(this.inlineLexer.nowrap=!0,a=this.inlineLexer.translate(a),this.inlineLexer.nowrap=!1):a=h?'<pre class="'+f.languagePrefix+m(f.sanitize?h.replace(/  */g,"-"):h)+'">'+(b?a:m(a))+"</pre>":"<pre>"+(b?a:m(a))+"</pre>";a="\n"+a;break;case "heading":a=this.inlineLexer.translate(a);b=b?' id="'+f.generalPrefix+"heading-"+this.headingIndex++ +'"':"";h=d.size+f.headingBase-1;a=6>=h?"\n<h"+h+b+">"+a+"</h"+h+">":"\n<p"+b+' class="'+f.generalPrefix+"heading-"+d.size+'">'+a+
"</p>";break;case "figure":b="";var h=this.inlineLexer.filterCss(d.width),r=this.inlineLexer.filterCss(d.height),c=d.align;f.stylish&&(h||r||c)&&(b=' style="'+(c?"float:"+m(c)+";":"")+(h?"width:"+m(h)+";":"")+(r?"height:"+m(r)+";":"")+'"');a=this.inlineLexer.wrap(a.replace(L,"$1"),null,!0);a='\n<img src="'+m(d.href)+'"'+(a?' alt="'+m(a)+'"':"")+(d.title?' title="'+m(d.title)+'"':"")+(!f.stylish&&c?' align="'+c+'"':"")+(f.stylish?b:(h?' width="'+m(h)+'"':"")+(r?' height="'+m(r)+'"':""))+(f.xhtml?"/>":
">");break;case "quote_start":for(a="\n<blockquote>";"quote_end"!==this.next().type;)a+=this.translate();a+="\n</blockquote>";break;case "li":a=this.inlineLexer.translate(a,d.complexMode);a="\n<li>"+(d.complexMode?"\n<p>"+a+"</p>\n</li>":a+"</li>");break;case "li_start":a="\n<li>";for(f=a.length;"li_end"!==this.next().type;)this.token.complexMode=d.complexMode,a+=this.translate();a="\n"===a.charAt(f)?a+"\n</li>":a+"</li>";break;case "ul_start":for(a="\n<ul>";"ul_end"!==this.next().type;)this.token.complexMode=
d.complex,a+=this.translate();a+="\n</ul>";break;case "ol_start":for(a="\n<ol>";"ol_end"!==this.next().type;)this.token.complexMode=d.complex,a+=this.translate();a+="\n</ol>";break;case "text":(a=this.inlineLexer.translate(a,d.complexMode))&&d.complexMode&&(a="\n<p>"+a+"</p>");break;case "note_start":a="";if(this.tokens.notes[d.name].index===d.index){for(;"note_end"!==this.next().type;)a+=this.translate();this.tokens.notes[d.name].text=a;a=""}break;case "td":case "th":a=this.inlineLexer.translate(a);
a="\n<"+d.type+(1<d.colspan?' colspan="'+d.colspan+'"':"")+(1<d.rowspan?' rowspan="'+d.rowspan+'"':"")+(f.stylish?' style="text-align:'+d.align+';"':' align="'+d.align+'"')+">"+a+"</"+d.type+">";break;case "tr_start":for(a="\n<tr>";"tr_end"!==this.next().type;)a+=this.translate();a+="\n</tr>";break;case "tbody_start":for(a="\n<tbody>";"tbody_end"!==this.next().type;)a+=this.translate();a+="\n</tbody>";break;case "table_start":for(a="\n<table>";"table_end"!==this.next().type;)a+=this.translate();a+=
"\n</table>";break;case "thead_start":for(a="\n<thead>";"thead_end"!==this.next().type;)a+=this.translate();a+="\n</thead>";break;case "tfoot_start":for(a="\n<tfoot>";"tfoot_end"!==this.next().type;)a+=this.translate();a+="\n</tfoot>";break;case "hr":a="\n<hr"+(f.xhtml?"/>":">");break;case "dt":a=this.inlineLexer.translate(a);a="\n<dt>"+a+"</dt>";break;case "dd":a=this.inlineLexer.translate(a,d.complexMode);a="\n<dd>"+(d.complexMode?"\n<p>"+a+"</p>\n</dd>":a+"</dd>");break;case "dd_start":a="\n<dd>";
for(f=a.length;"dd_end"!==this.next().type;)this.token.complexMode=d.complexMode,a+=this.translate();a="\n"===a.charAt(f)?a+"\n</dd>":a+"</dd>";break;case "dl_start":for(a="\n<dl>";"dl_end"!==this.next().type;)this.token.complexMode=d.complex,a+=this.translate();a+="\n</dl>";break;case "macro":a=(a=this.options.macros[this.token.name])?a.call(u,this,d):"";break;default:throw Error('Token "'+this.token.type+'" does not have a renderer.');}return a};y.prototype.generateContents=function(b,f){for(var d=
this.options,a=this.inlineLexer,h='\n<div id="'+d.generalPrefix+'contents">'+(f?'\n<div class="'+d.generalPrefix+'contents-title">'+a.translate(f)+"</div>":""),r=0,c=0,g;g=b[c];c++){var p=g.size;if(p>r)for(var e=0,n=p-r;e<n;e++)h=e||r?h+"\n<li><ul>":h+"\n<ul>";else if(p<r)for(e=0,n=r-p;e<n;e++)h+="\n</ul></li>";h+='\n<li><a href="#'+d.generalPrefix+"heading-"+g.index+'">'+m(a.translate(g.text,null,!0),!0)+"</a></li>";r=p}e=0;for(n=r-1;e<=n;e++)h=e<n?h+"\n</ul></li>":h+"\n</ul>";return(h+"\n</div>").replace(/<\/li>\n<li><ul>/g,
"\n<ul>").replace(/<\/ul><\/li>/g,"</ul>\n</li>")};y.prototype.generateFootnote=function(b){var f=[];for(d in b)f.push(b[d]);if(1>f.length)return"";f.sort(function(a,b){return a.index<b.index?-1:1});b=this.options;var d='\n<div id="'+b.generalPrefix+'footnotes">\n<hr'+(b.xhtml?"/>":">")+"\n<table>\n<tbody"+(b.stylish?' style="vertical-align:top;"':' valign="top"')+">";for(var a=0,h;h=f[a];a++){var m="\n<tr"+(' class="'+b.generalPrefix+'footnote" id="'+b.generalPrefix+"footnote-"+h.index+'"')+">\n<td>["+
h.index+"]</td>\n<td>"+(h.escaped?h.text:this.inlineLexer.translate(h.text));switch(h.refs.length){case 0:break;case 1:m+=(h.escaped?"\n<p><em>":" <em>")+'<a class="'+b.generalPrefix+'footnote-backref" href="#'+b.generalPrefix+"ref-footnote-"+h.refs[0]+'">&#8617;</a>'+(h.escaped?"</em></p>":"</em>");break;default:for(var m=m+((h.escaped?"\n<p><em>":" <em>")+"&#8617;("),c=0,g=h.refs.length-1;c<=g;c++)m+='<a class="'+b.generalPrefix+'footnote-backref" href="#'+b.generalPrefix+"ref-footnote-"+h.refs[c]+
'">'+h.refs[c]+"</a>"+(c<g?", ":"");m+=h.escaped?")</em></p>":")</em>"}d+=m+(h.escaped?"\n":"")+"</td>\n</tr>"}return d+"\n</tbody>\n</table>\n</div>"};var u=function(b,f,d){"function"===typeof f&&(d=f,f=null);f&&(f=H({},u.defaults,f));if(d){var a=f.highlight,h=null;try{h=E.lex(b,f)}catch(p){return d(p)}var n=function(){try{var b=y.parse(h,f)}catch(T){var c=T}f.highlight=a;return c?d(c):d(null,b)};if(!a||4>a.length)return n();delete f.highlight;var c=h.length;if(!c)return n();b=0;for(var g=h.length;b<
g;b++)(function(b){if("code"!==b.type||b.mix||b.escaped)return--c||n();a(b.text,b.lang,b.raw,function(a,d){if(a){if((f||u.defaults).silent)return b.text="<p>An error occured:</p><pre>"+m(a.message+"")+"</pre>",b.escaped=!0,--c||n();throw a;}if(!d||d===b.text)return--c||n();b.text=d;b.escaped=!0;--c||n()})})(h[b])}else try{return y.parse(E.lex(b,f),f)}catch(p){p.message+="\nPlease report this to https://github.com/jakwings/strictdown/issues";if((f||u.defaults).silent)return"<p>An error occured:</p><pre>"+
m(p.message+"")+"</pre>";throw p;}};u.setOptions=function(b){H(u.defaults,b);return u};u.setMacros=function(b){H(u.defaults.macros,b);return u};u.defaults={silent:!1,sanitize:!1,pedantic:!1,hardtab:!1,xhtml:!1,wrappingMode:"default",headingBase:1,generalPrefix:"smd-",languagePrefix:"lang-",baseUri:"",stylish:!0,highlight:null,macros:{toc:function(b,f){if(b instanceof this.BlockLexer)return f.text=f.text.replace(C,"$1"),f;if(b instanceof this.Parser)return b.generateContents(b.tokens.headings,f.text)}}};
u.helpers={escape:m,quotemeta:O,pad:P,split:Q,merge:H,reTrim:C,reEscape:L,reEscape2:D,isIndented:I,splitTableRow:R};u.BlockLexer=E;u.BlockLex=E.lex;u.InlineLexer=A;u.InlineLex=A.translate;u.Parser=y;u.tokenize=E.lex;u.parse=y.parse;"object"===typeof exports?module.exports=u:"function"===typeof define&&define.amd?define("strictdown",function(){return u}):S.strictdown=u})(this);
